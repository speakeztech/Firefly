# Compilation Pipeline

## Overview

The compilation pipeline flows through these major phases:

```
F# Source → FCS → PSG → Nanopasses → Alex/Zipper → MLIR → LLVM → Native Binary
```

## Pipeline Stages

### 1. F# Source
- User-written F# code
- Uses Alloy library for runtime-free implementations
- Project configured via `.fidproj` TOML files

### 2. FCS (F# Compiler Services)
- **Location**: `/src/Core/FCS/`
- **Purpose**: Provides parsing, type checking, and semantic analysis
- **Key Point**: Single source of truth for F# semantics
- **Documentation**: `docs/FCS_*.md`

### 3. PSG (Program Semantic Graph)
- **Location**: `/src/Core/PSG/`
- **Purpose**: Unified intermediate representation correlating syntax with semantics
- **Key Point**: THE SINGLE SOURCE OF TRUTH for all downstream stages
- **Capabilities**:
  - Enables reachability analysis for dead code elimination
  - Fan-out traversal from entry points
  - Carries proofs about memory lifetimes, type safety, resource ownership, and coeffects
- **Documentation**: `docs/PSG_*.md`

### 4. Nanopasses
- **Location**: `/src/Core/PSG/Nanopass/`
- **Purpose**: Small, single-purpose transformations that enrich the PSG
- **Design**:
  - Each pass does ONE thing (add def-use edges, classify operations, etc.)
  - Passes are composable and can be inspected independently
- **Current Passes**:
  - `IntermediateEmission.fs` - Emit intermediate files
  - `FlattenApplications.fs` - Flatten nested function applications
  - `ReducePipeOperators.fs` - Transform pipe operators
  - `DefUseEdges.fs` - Add definition-use edges
  - `ParameterAnnotation.fs` - Annotate parameters
  - `ClassifyOperations.fs` - Classify operations by kind
  - `LowerInterpolatedStrings.fs` - Lower interpolated strings
- **Documentation**: `docs/PSG_Nanopass_Architecture.md`

### 5. Alex/Zipper
- **Location**: `/src/Alex/`
- **Purpose**: Multi-dimensional hardware targeting layer ("Library of Alexandria")
- **Components**:
  - **Zipper** (`Traversal/`): The traversal engine - the "attention" of Alex
  - **XParsec** (`Traversal/PSGXParsec.fs`): Pattern matching combinators for PSG structures
  - **Bindings** (`Bindings/`): Platform-aware MLIR generation
  - **CodeGeneration**: Type mapping, MLIR builders
  - **Pipeline**: Orchestration, FCS integration, lowering, optimization

### 6. MLIR
- **Purpose**: Multi-Level Intermediate Representation
- **Key Point**: Progressive lowering through dialects
- **Generated by**: Alex Bindings based on PSG traversal

### 7. LLVM
- **Purpose**: Low-level code generation
- **Output**: Native machine code

### 8. Native Binary
- **Output Types**:
  - `freestanding` - No runtime dependencies
  - `console` - Minimal libc dependency
- **Key Point**: "Compiles" means a working native binary that executes correctly

## The Fidelity Preservation

The PSG is not merely an AST - it is a **semantic graph carrying proofs** about:
- Memory lifetimes
- Type safety
- Resource ownership
- Coeffects

Alex consumes this rich semantic information to generate MLIR that preserves all guarantees.

## Key Constraint

> **"Compiles" means a working native binary that executes correctly, not just successful parsing or IR generation.**

Every change must be validated end-to-end with a working binary.
